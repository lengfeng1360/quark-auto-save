<style>
    /* Fix checkbox visibility in dark theme */
    .form-check-input {
        background-color: #495057;
        border-color: #6c757d;
    }
    
    .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    
    .form-check-input:focus {
        border-color: #86b7fe;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    /* Ensure proper contrast for text in results */
    .list-group-item {
        background-color: #212529;
        border-color: #373b3e; /* Softer border */
        transition: background-color 0.2s;
    }
    
    .list-group-item:hover {
        background-color: #2c3034;
    }

    /* File Tree Styles */
    .file-tree-item {
        display: flex;
        align-items: center;
        width: 100%;
        overflow: hidden;
    }

    .file-name-wrapper {
        display: flex;
        align-items: center;
        flex-grow: 1;
        min-width: 0; /* Allows text truncation to work in flex child */
        cursor: pointer;
        padding-right: 10px;
        user-select: none;
    }

    .file-name-text {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .toggle-icon-area {
        width: 24px;
        flex-shrink: 0;
        display: inline-flex;
        justify-content: center;
        align-items: center;
    }

    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: #212529;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #495057;
        border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #6c757d;
    }
    /* 防止按钮文字换行 */
    #transferButton {
        white-space: nowrap;
    }
</style>

<div class="container mt-4">
    <!-- Input Card Section -->
    <div class="row justify-content-center mb-4">
        <div class="col-lg-8 mx-auto">
            <div class="card bg-dark text-white border-secondary shadow-sm">
                <div class="card-body p-4">
                    <h5 class="card-title mb-3"><i class="bi bi-link-45deg"></i> 解析分享链接</h5>
                    <div class="mb-3">
                        <textarea class="form-control bg-secondary text-white border-0" id="shareLink" rows="2" placeholder="在此粘贴分享链接（例如 https://pan.quark.cn/s/xxx 提取码: 1234）"></textarea>
                    </div>
                    <button id="analyzeButton" class="btn btn-primary w-100" type="button"><i class="bi bi-arrow-down-up"></i> 解析并获取</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="text-center mt-4" style="display: none;">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
    </div>

    <!-- Error Message -->
    <div id="errorMessageContainer" class="row justify-content-center mt-4" style="display: none;">
        <div class="col-md-6">
            <div id="errorMessage" class="alert alert-danger" role="alert"></div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="transferResultsSection" class="row justify-content-center mt-4" style="display: none;">
        <div class="col-lg-8 mx-auto">
            <div class="card bg-dark text-white border-secondary shadow-sm">
                <div class="card-header border-secondary d-flex justify-content-between align-items-center bg-dark">
                    <h5 class="mb-0 mx-auto"><i class="bi bi-folder2-open"></i> 文件列表</h5>
                </div>
                <div class="card-body p-0">
                    <div id="transferResultsContainer" class="text-start custom-scrollbar" style="max-height: 500px; overflow-y: auto;">
                    </div>
                </div>
                <div class="card-footer border-secondary bg-dark">
                    <div class="input-group">
                        <span class="input-group-text bg-secondary text-white border-secondary">保存到</span>
                        <input type="text" class="form-control bg-dark text-white border-secondary" id="savePathInput" placeholder="/ (根目录) 或 /我的文件夹" value="/">
                        <button id="transferButton" class="btn btn-success" type="button" style="display: none;"><i class="bi bi-cloud-download"></i> 转存</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // This function will be called when the transfer page is shown
    const populateShareUrl = () => {
        const shareUrl = localStorage.getItem('shareUrlToTransfer');
        if (shareUrl) {
            const shareLinkTextarea = document.getElementById('shareLink');
            if(shareLinkTextarea) {
                shareLinkTextarea.value = shareUrl;
                localStorage.removeItem('shareUrlToTransfer'); // Clean up after use
                // Trigger analysis automatically
                const analyzeBtn = document.getElementById('analyzeButton');
                if (analyzeBtn) {
                     setTimeout(() => analyzeBtn.click(), 100);
                }
            }
        }
    };

    // We need a way to detect when this tab becomes visible.
    // A simple way is to use a custom event dispatched from the main page.
    document.body.addEventListener('showPage', function(e) {
        if (e.detail.pageId === 'transfer') {
            populateShareUrl();
        }
    });

    // Load default save path from config
    const loadDefaultSavePath = () => {
        axios.get('/api/public_config')
            .then(response => {
                if(response.data.success) {
                    const defaultPath = response.data.data.save_path_default;
                    const savePathInput = document.getElementById('savePathInput');
                    if(typeof defaultPath === 'string' && savePathInput) {
                        savePathInput.value = defaultPath;
                    }
                }
            })
            .catch(error => console.error("加载配置失败:", error));
    };
    loadDefaultSavePath();

    const analyzeButton = document.getElementById('analyzeButton');
    const shareLinkTextarea = document.getElementById('shareLink');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const errorMessage = document.getElementById('errorMessage');
    const resultsContainer = document.getElementById('transferResultsContainer');

    const transferButton = document.getElementById('transferButton');

    let currentShareData = {};

    const analyzeAndFetch = () => {
        const shareUrl = shareLinkTextarea.value.trim();
        if (!shareUrl) {
            errorMessage.textContent = '请粘贴分享链接。';
            document.getElementById('errorMessageContainer').style.display = 'block';
            return;
        }

        loadingSpinner.style.display = 'block';
        document.getElementById('errorMessageContainer').style.display = 'none';
        document.getElementById('transferResultsSection').style.display = 'none';
        resultsContainer.innerHTML = '';

        axios.post('/get_share_detail', { shareurl: shareUrl })
            .then(response => {
                loadingSpinner.style.display = 'none';
                if (response.data.success) {
                    currentShareData = {
                        stoken: response.data.data.stoken,
                        shareId: response.data.data.share_id,
                        pwd_id: response.data.data.pwd_id,
                        originalShareUrl: shareUrl
                    };

                    transferButton.style.display = 'inline-block';
                    document.getElementById('transferResultsSection').style.display = 'block';
                    renderResults(response.data.data, resultsContainer, true);
                    // If the root is a single folder, expand it immediately
                    if (response.data.data.list.length === 1 && response.data.data.list.dir) {
                        const firstFolderElement = resultsContainer.querySelector('.list-group-item span[style*="cursor: pointer"]');
                        if(firstFolderElement) {
                            firstFolderElement.click();
                        }
                    }
                } else {

                    transferButton.style.display = 'none';
                    // Try to get error message from different possible fields
                    const errorMsg = response.data.data?.error || response.data.message || '无法解析链接。';
                    errorMessage.textContent = errorMsg;
                    document.getElementById('errorMessageContainer').style.display = 'block';
                }
            })
            .catch(error => {
                loadingSpinner.style.display = 'none';
                console.error('获取详情时出错:', error);
                let msg = '获取详情时发生错误。';
                if (error.response && error.response.data && error.response.data.message) {
                    msg += ' ' + error.response.data.message;
                } else if (error.message) {
                     msg += ' ' + error.message;
                }
                errorMessage.textContent = msg;
                document.getElementById('errorMessageContainer').style.display = 'block';
            });
    };

    const getShareUrlForFid = (originalUrl, fid) => {
        // This logic is borrowed from the original index.html's getShareurl method
        let baseUrl = originalUrl.match(`.*s/[a-z0-9]+(\\?pwd=[^#]+)?`);
        if (fid === '0') {
            return baseUrl;
        }
        return `${baseUrl}#/list/share/${fid}`;
    };

    const fetchAndRenderDirectory = (pdirFid, container) => {
        loadingSpinner.style.display = 'block';
        
        const newShareUrl = getShareUrlForFid(currentShareData.originalShareUrl, pdirFid);

        axios.post('/get_share_detail', {
            shareurl: newShareUrl,
            stoken: currentShareData.stoken // stoken is still needed
        })
        .then(response => {
            loadingSpinner.style.display = 'none';
            if (response.data.success) {
                // Update stoken in case it gets refreshed
                currentShareData.stoken = response.data.data.stoken;
                renderResults(response.data.data, container, false);
            } else {
                // Show error inside the folder's container
                container.innerHTML = `<li class="list-group-item bg-dark text-danger">错误: ${response.data.data.error}</li>`;
            }
        })
        .catch(error => {
            loadingSpinner.style.display = 'none';
            console.error('获取目录详情时出错:', error);
            container.innerHTML = `<li class="list-group-item bg-dark text-danger">发生错误。</li>`;
        });
    };

    const renderResults = (data, container, isRoot) => {
        if (isRoot) {
            container.innerHTML = '';
        }
        let fileList = data.list;
        // Handle case where the share is a folder, list is empty but first_file exists.
        if (isRoot && (!fileList || fileList.length === 0) && data.first_file && data.first_file.fid) {
             const singleFile = {
                 ...data.share,
                 ...data.first_file,
                 file_name: data.share.file_name || '未命名文件',
                 dir: true // It's a directory
             };
             fileList = [singleFile];
        } else if (isRoot && (!fileList || fileList.length === 0) && data.share && data.share.file_name) {
            const singleFile = {
                ...data.share,
                file_name: data.share.file_name || '未命名文件',
                dir: false,
            };
            fileList = [singleFile];
        }
        if (!fileList || fileList.length === 0) {
            const emptyMessage = document.createElement('li');
            emptyMessage.className = 'list-group-item bg-dark text-white';
            emptyMessage.textContent = '此文件夹为空。';
            container.appendChild(emptyMessage);
            return;
        }

        const listGroup = document.createElement('ul');
        listGroup.className = `list-group list-group-flush ${isRoot ? '' : 'ms-3 border-start border-secondary'}`;

        fileList.forEach(file => {
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item bg-dark text-white px-3 py-2 border-bottom border-secondary';
            listItem.style.borderColor = '#373b3e';

            const row = document.createElement('div');
            row.className = 'file-tree-item';

            // Checkbox
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'form-check-input me-3';
            checkbox.dataset.fid = file.fid;
            checkbox.dataset.fidToken = file.share_fid_token;

            checkbox.onchange = (e) => {
                const isChecked = e.target.checked;
                const listItem = e.target.closest('.list-group-item');
                const subContainer = listItem.querySelector('.sub-container');
                
                // 1. 当勾选/取消勾选时，影响所有子项
                if (subContainer) {
                    const childCheckboxes = subContainer.querySelectorAll('input[type="checkbox"]');
                    childCheckboxes.forEach(child => {
                        child.checked = isChecked;
                        // 递归触发子项的 onchange，以处理更深层的嵌套
                        child.dispatchEvent(new Event('change'));
                    });
                }
                
                // 2. 更新所有父级的状态
                updateParentCheckboxState(e.target);
            };
            row.appendChild(checkbox);

            // Wrapper for Name and Icon to handle clicks and layout
            const fileNameWrapper = document.createElement('div');
            fileNameWrapper.className = 'file-name-wrapper';
            
            // Icon Determination
            let iconClass = 'bi-file-earmark';
            let iconColor = 'text-secondary';
            if (file.dir) {
                iconClass = 'bi-folder-fill';
                iconColor = 'text-warning';
            } else if (file.obj_category === 'video') {
                iconClass = 'bi-film';
                iconColor = 'text-info';
            } else if (file.obj_category === 'image') {
                iconClass = 'bi-image';
                iconColor = 'text-success';
            } else if (file.obj_category === 'audio') {
                iconClass = 'bi-music-note-beamed';
                iconColor = 'text-danger';
            }

            // Toggle Icon Area (Arrow)
            const toggleIconArea = document.createElement('span');
            toggleIconArea.className = 'toggle-icon-area me-1';
            
            // Toggle Icon element (we create it but only populate useful content if dir)
            const toggleIcon = document.createElement('i');
            toggleIcon.className = 'toggle-icon bi';
            
             if (file.dir) {
                toggleIcon.classList.add('bi-caret-right-fill', 'text-muted');
                toggleIconArea.appendChild(toggleIcon);
            }
            fileNameWrapper.appendChild(toggleIconArea);

            // File Type Icon
            const fileIcon = document.createElement('i');
            fileIcon.className = `bi ${iconClass} ${iconColor} me-2 fs-5`;
            fileNameWrapper.appendChild(fileIcon);

            // File Name Text
            const fileNameText = document.createElement('span');
            fileNameText.className = 'file-name-text';
            fileNameText.textContent = file.file_name;
            fileNameText.title = file.file_name;
            fileNameWrapper.appendChild(fileNameText);

            // Click Event for Directory
            if (file.dir) {
                fileNameWrapper.onclick = (e) => {
                    e.stopPropagation();
                    const subContainer = listItem.querySelector('.sub-container');
                   
                    if (subContainer) {
                        const isHidden = subContainer.style.display === 'none';
                        subContainer.style.display = isHidden ? 'block' : 'none';
                        if (isHidden) {
                            toggleIcon.classList.remove('bi-caret-right-fill');
                            toggleIcon.classList.add('bi-caret-down-fill');
                        } else {
                             toggleIcon.classList.remove('bi-caret-down-fill');
                            toggleIcon.classList.add('bi-caret-right-fill');
                        }
                    } else {
                        toggleIcon.classList.remove('bi-caret-right-fill');
                        toggleIcon.classList.add('bi-caret-down-fill');
                        
                        const newSubContainer = document.createElement('div');
                        newSubContainer.className = 'sub-container mt-2';
                        listItem.appendChild(newSubContainer);
                        fetchAndRenderDirectory(file.fid, newSubContainer);
                    }
                };
            }

            row.appendChild(fileNameWrapper);

            // Size Badge
            const sizeBadge = document.createElement('span');
            sizeBadge.className = 'badge bg-dark border border-secondary text-secondary ms-2 font-monospace';
            sizeBadge.textContent = file.size ? formatBytes(file.size) : (file.dir ? '-' : '0 B');
            
            row.appendChild(sizeBadge);
            listItem.appendChild(row);
            listGroup.appendChild(listItem);
        });

        container.appendChild(listGroup);
    };

    const formatBytes = (bytes, decimals = 2) => {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    };
    // 在 <script> 标签内，与 handleTransfer 同级
    const updateParentCheckboxState = (changedCheckbox) => {
        // 从当前复选框所在的列表项开始向上查找
        let parentItem = changedCheckbox.closest('.sub-container')?.closest('.list-group-item');
        
        while (parentItem) {
            const parentCheckbox = parentItem.querySelector('input[type="checkbox"]');
            const siblingCheckboxes = parentItem.querySelector('.sub-container')?.querySelectorAll('input[type="checkbox"]');
            
            if (siblingCheckboxes && siblingCheckboxes.length > 0) {
                const allChecked = Array.from(siblingCheckboxes).every(cb => cb.checked);
                const someChecked = Array.from(siblingCheckboxes).some(cb => cb.checked);

                parentCheckbox.checked = allChecked;
                parentCheckbox.indeterminate = someChecked && !allChecked;
            } else {
                // 如果父文件夹没有子项（例如，还没展开），它的状态由自己决定
                // 这种情况通常由点击事件直接处理
            }

            // 继续向上查找更上层的父级
            parentItem = parentItem.parentElement.closest('.sub-container')?.closest('.list-group-item');
        }
    };

        const handleTransfer = () => {
        // 1. 获取所有被选中的复选框
        const allSelectedCheckboxes = resultsContainer.querySelectorAll('input[type="checkbox"]:checked');
        
        // 这个列表将保存我们最终要发送给后端的项目
        const itemsToTransfer = [];

        // 2. 定义一个辅助函数，用于检查一个项目的父文件夹是否被“明确勾选”
        const isParentExplicitlySelected = (childCheckbox) => {
            const listItem = childCheckbox.closest('.list-group-item');
            const subContainer = listItem.parentElement;
            
            // 如果父容器就是根容器，说明它没有父文件夹
            if (subContainer.id === 'transferResultsContainer') {
                return false;
            }
            
            // 找到父文件夹所在的列表项
            const parentListItem = subContainer.closest('.list-group-item');
            if (!parentListItem) {
                return false; // 安全检查，理论上不应该发生
            }
            
            // 找到父文件夹的复选框
            const parentCheckbox = parentListItem.querySelector('input[type="checkbox"]');
            
            // 关键：只有当父项被选中 且 不是不确定状态 时，才认为父项被选中
            return parentCheckbox ? parentCheckbox.checked && !parentCheckbox.indeterminate : false;
        };

        // 3. 遍历所有被选中的项目进行过滤
        allSelectedCheckboxes.forEach(checkbox => {
            // 如果一个项目的父文件夹没有被“明确勾选”，那么它就是一个需要独立操作的项目。
            if (!isParentExplicitlySelected(checkbox)) {
                const listItem = checkbox.closest('.list-group-item');
                const fileName = listItem.querySelector('.file-name-text').textContent;
                const isDir = listItem.querySelector('.bi-folder-fill') !== null;
                const pathArray = buildRelativePath(listItem); 

                itemsToTransfer.push({
                    fid: checkbox.dataset.fid,
                    fid_token: checkbox.dataset.fidToken,
                    file_name: fileName,
                    is_dir: isDir,
                    path: pathArray // 直接使用数组
                });
            }
        });

        // 4. 检查过滤后是否有需要传输的项目
        if (itemsToTransfer.length === 0) {
            // 这种情况通常发生在用户只选中了子项，但其父项也隐含被选中时。
            // 或者用户根本没有选中任何东西。
            alert('请至少选择一个文件或文件夹进行下载。');
            return;
        }

        const savePath = document.getElementById('savePathInput').value.trim() || '/';

        // 5. 执行传输请求
        loadingSpinner.style.display = 'block';
        transferButton.disabled = true;

        // 调用新的API端点
        axios.post('/api/transfer_with_structure', {
            items: itemsToTransfer,
            base_save_path: savePath,
            stoken: currentShareData.stoken,
            pwd_id: currentShareData.pwd_id
        })
        .then(response => {
            loadingSpinner.style.display = 'none';
            transferButton.disabled = false;
            
            if (response.data.success) {
                alert(response.data.message);
                // 可选：传输成功后取消所有选择
                resultsContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
            } else {
                alert('下载失败: ' + response.data.message);
                if(response.data.errors) {
                    console.error(response.data.errors);
                }
            }
        })
        .catch(error => {
             loadingSpinner.style.display = 'none';
             transferButton.disabled = false;
             console.error('下载时出错:', error);
             alert('发生意外错误。');
        });
    };

    analyzeButton.addEventListener('click', analyzeAndFetch);
    transferButton.addEventListener('click', handleTransfer);

    // Initial check after listeners are set up
    populateShareUrl();
});
// 确保这个函数存在于您的 <script> 标签内
const buildRelativePath = (listItem) => {
    const parts = [];
    let current = listItem;
    while (current && current.id !== 'transferResultsContainer') {
        const fileNameElement = current.querySelector('.file-name-text');
        if (fileNameElement) {
            parts.unshift(fileNameElement.textContent);
        }
        current = current.parentElement.closest('.list-group-item');
    }
    return parts;
};
</script>