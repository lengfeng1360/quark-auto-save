<style>
    .library-sidebar {
        background-color: #161B22;
        padding: 20px;
        height: 800px;
        border-right: 1px solid #30363D;
        display: flex;
        flex-direction: column;
    }
    .library-content {
        padding: 20px;
        height: 100%;
        background-color: #0D1117;
        overflow-y: auto;
    }
    .file-explorer {
        background-color: #0D1117;
        border: 1px solid #30363D;
        border-radius: 6px;
        padding: 16px;
        color: #C9D1D9;
        flex: 1;
        overflow-y: auto;
    }
    .file-explorer::-webkit-scrollbar {
        width: 8px;
    }
    .file-explorer::-webkit-scrollbar-track {
        background: #0D1117;
    }
    .file-explorer::-webkit-scrollbar-thumb {
        background-color: #30363D;
        border-radius: 4px;
        border: 2px solid #0D1117;
    }
    .file-explorer::-webkit-scrollbar-thumb:hover {
        background-color: #58A6FF;
    }
    .file-explorer .list-group {
        margin-bottom: 0;
    }
    .file-explorer .list-group-item {
        background-color: transparent;
        border: none;
        color: #C9D1D9;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 4px;
        margin-bottom: 2px;
        transition: background-color 0.2s;
        display: flex;
        align-items: flex-start;
    }
    .file-explorer .list-group-item .form-check-input {
        margin-top: 0.3rem;
        flex-shrink: 0;
        width: 1.1em;
        height: 1.1em;
        min-width: 1.1em;
    }
    .file-explorer .list-group-item .badge {
        margin-top: 0.2rem;
    }
    .file-explorer .list-group-item:hover {
        background-color: #21262D;
    }
    .file-explorer .list-group-item.active {
        background-color: #0969DA;
    }
    .file-explorer .list-group-item i {
        color: #8B949E;
        width: 16px;
        text-align: center;
        flex-shrink: 0;
    }
    .file-explorer .list-group-item.video-item {
        border-left: 3px solid transparent;
    }
    .file-explorer .list-group-item.video-item:hover {
        border-left-color: #0d6efd;
    }
    .file-info-container {
        min-width: 0;
    }
    .storage-usage {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #30363D;
    }
    .progress-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: conic-gradient(#0d6efd var(--usage-percent), #30363D 0);
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
    }
    .progress-circle::before {
        content: '';
        position: absolute;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: #161B22;
    }
    .progress-circle span {
        position: relative;
        font-size: 0.8rem;
        font-weight: bold;
    }
    .breadcrumb {
        background-color: transparent;
        padding: 0;
        margin-bottom: 16px;
    }
    .breadcrumb-item {
        color: #8B949E;
    }
    .breadcrumb-item.active {
        color: #C9D1D9;
    }
    .breadcrumb-item a {
        color: #58A6FF;
        text-decoration: none;
    }
    .breadcrumb-item a:hover {
        text-decoration: underline;
    }
    .file-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
    }
    .file-card {
        background-color: #161B22;
        border: 1px solid #30363D;
        border-radius: 8px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s;
        height: 200px;
        display: flex;
        flex-direction: column;
    }
    .file-card:hover {
        background-color: #21262D;
        border-color: #58A6FF;
    }
    .file-card.video-card {
        position: relative;
    }
    .file-card .file-icon {
        font-size: 3rem;
        color: #8B949E;
        margin-bottom: 12px;
        text-align: center;
    }
    .file-card .file-name {
        color: #C9D1D9;
        font-size: 0.85rem; /* 稍微减小字体大小 */
        text-align: center;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2; /* 限制最多显示2行 */
        -webkit-box-orient: vertical;
        line-height: 1.3; /* 设置行高 */
        max-height: 2.6em; /* 2行文本的最大高度 */
        word-break: break-all; /* 允许在任何字符处换行 */
        padding: 0 4px; /* 添加一些水平内边距 */
        white-space: normal; /* 允许换行 */
    }
    .file-card .file-name .common-prefix,
    .file-card .file-name .common-suffix,
    .file-card .file-name .common-part,
    .list-group-item .common-part,
    .video-info .common-part {
        color: #8B949E;
        font-weight: normal;
    }

    .file-card .file-name .unique-part,
    .list-group-item .unique-part,
    .video-info .unique-part {
        color: #58A6FF;
        font-weight: bold;
    }
    .file-card .file-size {
        color: #8B949E;
        font-size: 0.8rem;
        text-align: center;
        margin-top: auto;
    }
    .file-card .play-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s;
    }
    .file-card:hover .play-overlay {
        opacity: 1;
    }
    .loading-spinner {
        text-align: center;
        padding: 20px;
    }
    .error-message {
        color: #f85149;
        text-align: center;
        padding: 20px;
    }
    .video-player {
        width: 100%;
        height: 60vh;
        background-color: #000;
        border-radius: 8px;
        margin-bottom: 16px;
    }
    .video-container.is-fullscreen .video-player {
        border-radius: 0;
    }
    .video-info {
        background-color: #161B22;
        border: 1px solid #30363D;
        border-radius: 8px;
        padding: 16px;
    }
    .video-container {
        position: relative;
    }
    .close-video-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 2rem;
        color: white;
        background-color: rgba(0, 0, 0, 0.5);
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        line-height: 1;
        padding: 0;
        text-align: center;
        cursor: pointer;
        z-index: 10;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .close-video-btn:hover {
        background-color: rgba(0, 0, 0, 0.8);
    }
    .video-controls {
        background-color: #161B22;
        border: 1px solid #30363D;
        border-radius: 8px;
        padding: 12px;
        margin-top: 10px;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        color: #C9D1D9;
    }
    .video-control-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .video-control-input {
        background-color: #0D1117;
        border: 1px solid #30363D;
        color: #C9D1D9;
        border-radius: 4px;
        padding: 4px 8px;
        width: 70px;
    }
    .video-control-input:focus {
        border-color: #58A6FF;
        outline: none;
    }
    .form-switch .form-check-input {
        background-color: #30363D;
        border-color: #30363D;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%238B949E'/%3e%3c/svg%3e");
    }
    .form-switch .form-check-input:checked {
        background-color: #1f6feb;
        border-color: #1f6feb;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23ffffff'/%3e%3c/svg%3e");
    }
    .video-loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 20;
        border-radius: 8px;
        color: white;
    }
</style>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-3 library-sidebar">
            <div class="file-explorer">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center flex-grow-1">
                        <button class="btn btn-sm btn-outline-secondary me-2" id="backBtn" disabled>
                            <i class="bi bi-arrow-left"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary me-2" id="refreshBtn">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" id="deleteBtn" disabled>
                            <i class="bi bi-trash"></i>
                        </button>
                        <span class="text-muted ms-auto" id="currentPath">/</span>
                    </div>
                </div>
                 <div class="d-flex align-items-center mb-2">
                    <input type="checkbox" class="form-check-input me-2" id="selectAllCheckbox">
                    <label for="selectAllCheckbox" class="form-check-label">全选</label>
                </div>
                <ul class="list-group" id="fileList">
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </ul>
            </div>
        </div>
        <div class="col-md-9 library-content">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb" id="breadcrumb">
                    <li class="breadcrumb-item active">加载中...</li>
                </ol>
            </nav>
            <div id="contentArea">
                <div class="d-flex justify-content-center align-items-center h-100">
                    <div class="text-center">
                        <i class="bi bi-collection-play" style="font-size: 5rem; color: #8B949E;"></i>
                        <p class="text-muted">从您的 OpenList/Alist 服务器浏览文件</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentPath = '/';
let currentFiles = [];
let currentVideoCommonSubstrings = [];
let isVideoPlaying = false;
let libraryInitialized = false;
let selectedFiles = new Set();
let playerSettings = {
    autoNext: false,
    skipStart: 0,
    skipEnd: 0
};
let isRequestingVideo = false;

// 页面显示时初始化
document.addEventListener('showPage', function(event) {
    if (event.detail.pageId === 'library') {
        setTimeout(initLibrary, 100); // 延迟一点时间确保DOM完全加载
    }
});

// 也检查页面是否已经可见
if (document.getElementById('library') && document.getElementById('library').style.display !== 'none') {
    setTimeout(initLibrary, 100);
}

// 添加 MutationObserver 来监听页面显示状态变化
const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
            const libraryPage = document.getElementById('library');
            if (libraryPage && libraryPage.style.display !== 'none') {
                setTimeout(initLibrary, 100);
                observer.disconnect(); // 只执行一次
            }
        }
    });
});

// 开始观察 library 页面的 style 属性变化
const libraryPage = document.getElementById('library');
if (libraryPage) {
    observer.observe(libraryPage, { attributes: true });
}

// 添加一个简单的点击测试
document.addEventListener('DOMContentLoaded', function() {
    console.log('Library page loaded');
    
    // 为 library 标签添加点击监听器作为备用
    const libraryNavLink = document.querySelector('[data-page="library"]');
    if (libraryNavLink) {
        console.log('Found library nav link, adding click listener');
        libraryNavLink.addEventListener('click', function(e) {
            console.log('Library nav link clicked');
            setTimeout(initLibrary, 200);
        });
    }
});

function initLibrary() {
    if (libraryInitialized) {
        return;
    }
    libraryInitialized = true;
    console.log('Initializing library...');
    // loadStorageInfo();
    loadPlayerSettings(); // 加载播放器设置
    loadFileList(currentPath);
    
    // 事件监听
    const backBtn = document.getElementById('backBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    
    const deleteBtn = document.getElementById('deleteBtn');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');

    if (backBtn) {
        backBtn.addEventListener('click', goBack);
    }
    if (refreshBtn) {
        refreshBtn.addEventListener('click', () => loadFileList(currentPath, true));
    }
    if (deleteBtn) {
        deleteBtn.addEventListener('click', deleteSelectedFiles);
    }
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', toggleSelectAll);
    }
}


function loadFileList(path, refresh = false) {
    currentPath = path;
    
    selectedFiles.clear();
    updateDeleteButtonState();
    document.getElementById('selectAllCheckbox').checked = false;

    // 更新UI状态
    document.getElementById('currentPath').textContent = path;
    document.getElementById('backBtn').disabled = path === '/';
    
    // 显示加载状态
    const fileList = document.getElementById('fileList');
    fileList.innerHTML = `
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
        </div>
    `;
    
    // 更新面包屑
    updateBreadcrumb(path);
    
    axios.post('/api/library/fs/list', { path: path, refresh: refresh })
        .then(response => {
            if (response.data.success) {
                currentFiles = response.data.data.content || [];
                
                // 计算当前目录视频文件的公共子串
                const videoFiles = currentFiles.filter(file => !file.is_dir && isVideoFile(file.name));
                const allVideoNames = videoFiles.map(file => file.name);
                currentVideoCommonSubstrings = findCommonSubstrings(allVideoNames);

                displayFileList(currentFiles);
                displayFileGrid(currentFiles);
            } else {
                // 特殊处理：如果后端返回 storage not found，视为新用户空目录，不报错
                if (response.data.message && response.data.message.includes('storage not found')) {
                    console.log('Storage not found, treating as empty directory (new user)');
                    currentFiles = [];
                    currentVideoCommonSubstrings = [];
                    displayFileList(currentFiles);
                    displayFileGrid(currentFiles);
                } else {
                    showError('加载文件失败: ' + response.data.message);
                }
            }
        })
        .catch(error => {
            console.error('Error loading file list:', error);
            showError('加载文件失败');
        });
}

function displayFileList(files) {
    const fileList = document.getElementById('fileList');
    
    if (files.length === 0) {
        fileList.innerHTML = '<div class="text-center text-muted p-3">空目录</div>';
        return;
    }
    
    let html = '';

    // 排序：文件夹在前，然后是文件
    const sortedFiles = files.sort((a, b) => {
        if (a.is_dir && !b.is_dir) return -1;
        if (!a.is_dir && b.is_dir) return 1;
        return a.name.localeCompare(b.name);
    });
    
    sortedFiles.forEach(file => {
        const icon = file.is_dir ? 'bi-folder' : getFileIcon(file.name);
        const size = file.is_dir ? '' : formatBytes(file.size);
        
        let displayName = file.name;
        if (!file.is_dir && isVideoFile(file.name)) {
            const nameResult = highlightFileName(file.name, currentVideoCommonSubstrings);
            displayName = typeof nameResult === 'string' ? nameResult : nameResult.html;
        }

        html += `
            <li class="list-group-item ${!file.is_dir && isVideoFile(file.name) ? 'video-item' : ''}">
                <input type="checkbox" class="form-check-input me-2 file-checkbox" value="${file.name}" onchange="handleFileSelection()">
                <div class="flex-grow-1 d-flex align-items-start file-info-container" onclick="handleFileClick('${file.name}', ${file.is_dir}, event)">
                    <i class="bi ${icon} me-2 mt-1"></i>
                    <span title="${file.name}" style="word-break: break-all;">${displayName}</span>
                </div>
                ${size ? `<span class="badge bg-secondary ms-auto">${size}</span>` : ''}
            </li>
        `;
    });
    
    fileList.innerHTML = html;
}

function displayFileGrid(files) {
    if (isVideoPlaying) {
        return;
    }
    const contentArea = document.getElementById('contentArea');
    
    if (files.length === 0) {
        contentArea.innerHTML = `
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="text-center">
                    <i class="bi bi-folder-x" style="font-size: 5rem; color: #8B949E;"></i>
                    <p class="text-muted">空目录</p>
                </div>
            </div>
        `;
        return;
    }
    
    // 只显示视频文件
    const videoFiles = files.filter(file => !file.is_dir && isVideoFile(file.name));
    
    if (videoFiles.length === 0) {
        contentArea.innerHTML = `
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="text-center">
                    <i class="bi bi-film" style="font-size: 5rem; color: #8B949E;"></i>
                    <p class="text-muted">此目录中没有视频文件</p>
                </div>
            </div>
        `;
        return;
    }
    
    let html = '<div class="file-grid">';
    
    videoFiles.forEach(file => {
        html += `
            <div class="file-card video-card" onclick="playVideo('${file.name}')">
                <div class="file-icon">
                    <i class="bi ${getFileIcon(file.name)}"></i>
                </div>
                <div class="play-overlay">
                    <i class="bi bi-play-fill"></i>
                </div>
                <div class="file-name">${file.name}</div>
                <div class="file-size">${formatBytes(file.size)}</div>
            </div>
        `;
    });
    
    html += '</div>';
    contentArea.innerHTML = html;
}

function handleFileClick(fileName, isDir, event) {
    // 防止点击 Checkbox 时触发导航
    if (event && event.target.type === 'checkbox') {
        return;
    }
    if (isDir) {
        // 如果是上级目录
        if (fileName === '..') {
            navigateToParent();
            return;
        }
        navigateToDirectory(fileName);
    } else {
        if (isVideoFile(fileName)) {
            playVideo(fileName);
        }
    }
}

function navigateToDirectory(dirName) {
    const newPath = currentPath === '/' ? `/${dirName}` : `${currentPath}/${dirName}`;
    loadFileList(newPath);
}

function navigateToParent() {
    const parentPath = currentPath.substring(0, currentPath.lastIndexOf('/'));
    loadFileList(parentPath === '' ? '/' : parentPath);
}

function goBack() {
    navigateToParent();
}

function updateBreadcrumb(path) {
    const breadcrumb = document.getElementById('breadcrumb');
    const parts = path.split('/').filter(part => part);
    
    let html = '<li class="breadcrumb-item"><a href="#" onclick="loadFileList(\'/\')">主页</a></li>';
    
    let currentPath = '';
    parts.forEach((part, index) => {
        currentPath += '/' + part;
        if (index === parts.length - 1) {
            html += `<li class="breadcrumb-item active">${part}</li>`;
        } else {
            html += `<li class="breadcrumb-item"><a href="#" onclick="loadFileList('${currentPath}')">${part}</a></li>`;
        }
    });
    
    breadcrumb.innerHTML = html;
}

function playVideo(fileName) {
    if (isRequestingVideo) return;
    isRequestingVideo = true;

    // 立即显示播放界面（加载状态）
    showVideoPlayerLoading(fileName);

    const filePath = currentPath === '/' ? `/${fileName}` : `${currentPath}/${fileName}`;
    console.log('Playing video:', fileName, 'at path:', filePath);
    
    // 使用 POST 方法获取视频链接
    axios.post('/api/library/fs/download', { path: filePath })
        .then(response => {
            console.log('Download response:', response);
            if (response.data.success) {
                const downloadUrl = response.data.data.download_url;
                // 更新播放器源并开始播放
                updateVideoPlayerSource(fileName, downloadUrl);
            } else {
                console.error('Failed to get video URL:', response.data);
                // 在播放器界面显示错误
                showVideoPlayerError('获取视频地址失败: ' + response.data.message);
            }
        })
        .catch(error => {
            console.error('Error getting video URL:', error);
            showVideoPlayerError('网络请求失败: ' + error.message);
        })
        .finally(() => {
            isRequestingVideo = false;
        });
}

function showVideoPlayerLoading(fileName) {
    isVideoPlaying = true;
    const contentArea = document.getElementById('contentArea');
    
    let displayName = fileName;
    const nameResult = highlightFileName(fileName, currentVideoCommonSubstrings);
    displayName = typeof nameResult === 'string' ? nameResult : nameResult.html;

    // 如果播放器已经存在，只更新信息和显示遮罩
    const existingContainer = document.querySelector('.video-container');
    if (existingContainer) {
        // 更新标题
        const titleEl = existingContainer.querySelector('.video-info h5');
        if (titleEl) {
            titleEl.title = fileName;
            titleEl.innerHTML = displayName;
        }
        
        // 确保遮罩存在
        let overlay = existingContainer.querySelector('.video-loading-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.className = 'video-loading-overlay';
            // 插入到 video 元素之前或之后，这里插入到 container 的开头，并覆盖在 video 上
            // 但 video-player 有 margin-bottom，所以最好是覆盖在 video-player 的 wrapper 上
            // 简单处理：插入到 container 中，通过 z-index 覆盖
            // 为了定位准确，overlay 需要 absolute 定位，且 container 需要 relative (已设置)
            // overlay 高度应该是 video 的高度
            const videoEl = existingContainer.querySelector('.video-player');
            if (videoEl) {
                // 设置 overlay 大小位置匹配 video
                // 由于 CSS 中 .video-loading-overlay 已经是 absolute top 0 left 0 width 100% height 100%
                // 但 container 包含 info，我们只想覆盖 video 部分。
                // 方案：把 video 包裹在一个 wrapper 里，或者动态设置 overlay 高度。
                // 简单点：overlay 只覆盖 video 区域。
                // CSS 中修改一下，或者这里动态设置 style
                overlay.style.height = videoEl.offsetHeight + 'px'; // 临时对齐高度
            }
            existingContainer.insertBefore(overlay, existingContainer.firstChild);
        }
        
        overlay.innerHTML = `
            <div class="spinner-border text-primary mb-2" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">加载中...</span>
            </div>
            <div>正在解析视频地址...</div>
        `;
        overlay.style.display = 'flex';
        
        // 暂停旧视频并替换元素以清除之前的事件监听器
        const video = document.getElementById('mainVideoPlayer');
        if (video) {
            video.pause();
            const newVideo = video.cloneNode(true);
            newVideo.removeAttribute('src');
            video.parentNode.replaceChild(newVideo, video);
        }
        return;
    }

    // 如果播放器不存在，创建新的结构
    contentArea.innerHTML = `
        <div class="video-container">
            <button class="close-video-btn" onclick="closeVideoPlayer()">&times;</button>
            
            <div class="video-wrapper" style="position: relative;">
                <div class="video-loading-overlay">
                    <div class="spinner-border text-primary mb-2" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <div>正在解析视频地址...</div>
                </div>
                <video id="mainVideoPlayer" class="video-player" controls autoplay>
                    您的浏览器不支持 video 标签。
                </video>
            </div>
            
            <div class="video-controls">
                <div class="video-control-item form-switch">
                    <input class="form-check-input" type="checkbox" id="autoNextSwitch" ${playerSettings.autoNext ? 'checked' : ''} onchange="updatePlayerSetting('autoNext', this.checked)">
                    <label class="form-check-label" for="autoNextSwitch">自动下一集</label>
                </div>
                <div class="video-control-item ms-3">
                    <label>跳过片头(秒):</label>
                    <input type="number" class="video-control-input" value="${playerSettings.skipStart}" min="0" onchange="updatePlayerSetting('skipStart', this.value)">
                </div>
                <div class="video-control-item ms-3">
                    <label>跳过片尾(秒):</label>
                    <input type="number" class="video-control-input" value="${playerSettings.skipEnd}" min="0" onchange="updatePlayerSetting('skipEnd', this.value)">
                </div>
            </div>

            <div class="video-info mt-3">
                <h5 title="${fileName}">${displayName}</h5>
                <p class="text-muted mb-0">播放路径: ${currentPath}</p>
            </div>
        </div>
    `;
}

function updateVideoPlayerSource(fileName, videoUrl) {
    const video = document.getElementById('mainVideoPlayer');
    const overlay = document.querySelector('.video-loading-overlay');
    
    if (video) {
        video.src = videoUrl;
        video.load();
        video.play().catch(e => console.log('Autoplay prevented:', e));

        // 移除所有控件的焦点，将焦点设置到视频元素上
        document.activeElement.blur();

        
        // 重新绑定事件监听器 (因为 playNextVideo 可能会依赖新的文件名)
        setupVideoPlayerListeners(fileName);
    }
    
    if (overlay) {
        overlay.style.display = 'none';
    }
}

function showVideoPlayerError(errorMessage) {
    const overlay = document.querySelector('.video-loading-overlay');
    if (overlay) {
        overlay.innerHTML = `
            <i class="bi bi-exclamation-circle text-danger mb-2" style="font-size: 3rem;"></i>
            <div class="text-danger">${errorMessage}</div>
            <button class="btn btn-sm btn-outline-light mt-3" onclick="closeVideoPlayer()">关闭</button>
        `;
    }
}

function loadPlayerSettings() {
    const saved = localStorage.getItem('quark_player_settings');
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            playerSettings = { ...playerSettings, ...parsed };
        } catch (e) {
            console.error('Failed to parse player settings', e);
        }
    }
}

function updatePlayerSetting(key, value) {
    if (key === 'skipStart' || key === 'skipEnd') {
        value = parseInt(value) || 0;
    }
    playerSettings[key] = value;
    localStorage.setItem('quark_player_settings', JSON.stringify(playerSettings));
}

function setupVideoPlayerListeners(currentFileName) {
    const video = document.getElementById('mainVideoPlayer');
    if (!video) return;

    // 新增：点击视频时移除焦点
    video.addEventListener('click', () => {
        video.blur();
    });

    // 处理跳过片头
    video.addEventListener('loadedmetadata', () => {
        if (playerSettings.skipStart > 0) {
            video.currentTime = playerSettings.skipStart;
        }
    });

    // 处理跳过片尾和自动下一集
    video.addEventListener('timeupdate', () => {
        if (playerSettings.skipEnd > 0 && video.duration > 0) {
            if (video.currentTime >= video.duration - playerSettings.skipEnd) {
                // 如果启用了自动下一集，则直接触发结束逻辑
                if (playerSettings.autoNext && !video.ended) {
                     // 手动触发结束，或者直接调用播放下一集
                     playNextVideo(currentFileName);
                     // 移除监听器防止重复触发
                     video.pause();
                }
            }
        }
    });

    video.addEventListener('ended', () => {
        if (playerSettings.autoNext) {
            playNextVideo(currentFileName);
        }
    });

    // 添加全屏变化事件监听
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
    document.addEventListener('mozfullscreenchange', handleFullscreenChange);
    document.addEventListener('MSFullscreenChange', handleFullscreenChange);
}

// 处理全屏变化事件
function handleFullscreenChange() {
    const videoContainer = document.querySelector('.video-container');
    if (!videoContainer) return;

    if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement) {
        // 进入全屏
        videoContainer.classList.add('is-fullscreen');
        document.activeElement.blur();
    } else {
        // 退出全屏
        videoContainer.classList.remove('is-fullscreen');
    }
}

// 全局键盘事件监听
document.addEventListener('keydown', function(event) {
    if (!isVideoPlaying) return;
    
    const video = document.getElementById('mainVideoPlayer');
    if (!video) return;

    // 避免在输入框中打字时触发快捷键
    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
        return;
    }

    switch(event.code) {
        case 'Space':
            event.preventDefault(); // 防止页面滚动
            if (video.paused) {
                video.play();
            } else {
                video.pause();
            }
            break;
        case 'ArrowLeft':
            event.preventDefault();
            video.currentTime = Math.max(0, video.currentTime - 10);
            break;
        case 'ArrowRight':
            event.preventDefault();
            video.currentTime = Math.min(video.duration, video.currentTime + 10);
            break;
        case 'ArrowUp':
            event.preventDefault();
            video.volume = Math.min(1, video.volume + 0.1);
            break;
        case 'ArrowDown':
            event.preventDefault();
            video.volume = Math.max(0, video.volume - 0.1);
            break;
    }
});

function playNextVideo(currentFileName) {
    // 找到当前目录下的所有视频文件
    const videoFiles = currentFiles.filter(file => !file.is_dir && isVideoFile(file.name));
    
    // 按名称排序（假设它们在 currentFiles 中已经是排序好的，或者重新排序以防万一）
    // currentFiles 在 loadFileList 中已经排过序了，videoFiles 保持相对顺序
    
    const currentIndex = videoFiles.findIndex(f => f.name === currentFileName);
    
    if (currentIndex !== -1 && currentIndex < videoFiles.length - 1) {
        const nextFile = videoFiles[currentIndex + 1];
        console.log('Auto playing next video:', nextFile.name);
        
        // 显示一个短暂的提示或加载状态（可选，这里直接切）
        playVideo(nextFile.name);
    } else {
        console.log('No next video found or last video reached.');
        // 可选：退出全屏，或者显示播放结束
    }
}

function closeVideoPlayer() {
    isVideoPlaying = false;
    // 重新显示文件网格
    displayFileGrid(currentFiles);
}

function getFileIcon(fileName) {
    const ext = fileName.split('.').pop().toLowerCase();
    const iconMap = {
        'mp4': 'bi-film',
        'mkv': 'bi-film',
        'avi': 'bi-film',
        'mov': 'bi-film',
        'wmv': 'bi-film',
        'flv': 'bi-film',
        'webm': 'bi-film',
        'm4v': 'bi-film',
        'txt': 'bi-file-text',
        'pdf': 'bi-file-pdf',
        'doc': 'bi-file-word',
        'docx': 'bi-file-word',
        'xls': 'bi-file-excel',
        'xlsx': 'bi-file-excel',
        'ppt': 'bi-file-ppt',
        'pptx': 'bi-file-ppt',
        'jpg': 'bi-file-image',
        'jpeg': 'bi-file-image',
        'png': 'bi-file-image',
        'gif': 'bi-file-image',
        'zip': 'bi-file-zip',
        'rar': 'bi-file-zip',
        '7z': 'bi-file-zip'
    };
    return iconMap[ext] || 'bi-file-earmark';
}

function isVideoFile(fileName) {
    const videoExts = ['mp4', 'mkv', 'avi', 'mov', 'wmv', 'flv', 'webm', 'm4v'];
    const ext = fileName.split('.').pop().toLowerCase();
    return videoExts.includes(ext);
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 字节';
    const k = 1024;
    const sizes = ['字节', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showError(message) {
    console.error('Library error:', message);
    const fileList = document.getElementById('fileList');
    const contentArea = document.getElementById('contentArea');

    // Clear the main content grid
    contentArea.innerHTML = '';

    // Display error in the file list sidebar
    fileList.innerHTML = `
        <div class="error-message p-3 text-center">
            <i class="bi bi-exclamation-triangle mb-2" style="font-size: 2rem;"></i>
            <p>${message}</p>
            <p class="text-muted small">Please check the browser console for more information</p>
            <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadFileList(currentPath, true);">
                <i class="bi bi-arrow-clockwise"></i> Retry
            </button>
        </div>
    `;
}

function handleFileSelection() {
    selectedFiles.clear();
    document.querySelectorAll('.file-checkbox:checked').forEach(checkbox => {
        selectedFiles.add(checkbox.value);
    });
    updateDeleteButtonState();

    const allCheckboxes = document.querySelectorAll('.file-checkbox');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    selectAllCheckbox.checked = allCheckboxes.length > 0 && selectedFiles.size === allCheckboxes.length;
}

function updateDeleteButtonState() {
    const deleteBtn = document.getElementById('deleteBtn');
    deleteBtn.disabled = selectedFiles.size === 0;
}

function toggleSelectAll() {
    const isChecked = document.getElementById('selectAllCheckbox').checked;
    document.querySelectorAll('.file-checkbox').forEach(checkbox => {
        checkbox.checked = isChecked;
    });
    handleFileSelection();
}

function deleteSelectedFiles() {
    const filesToDelete = Array.from(selectedFiles);
    if (filesToDelete.length === 0) {
        return;
    }

    if (!confirm(`Are you sure you want to delete ${filesToDelete.length} selected items? This action cannot be undone.`)) {
        return;
    }

    const pathsToDelete = filesToDelete.map(fileName => {
        return currentPath === '/' ? `/${fileName}` : `${currentPath}/${fileName}`;
    });

    axios.post('/api/library/fs/delete', { paths: pathsToDelete })
        .then(response => {
            if (response.data.success) {
                console.log('Files deleted successfully');
                loadFileList(currentPath, true); // 强制刷新
            } else {
                showError('Failed to delete: ' + response.data.message);
            }
        })
        .catch(error => {
            console.error('Error deleting files:', error);
            showError('Error while deleting');
        });
}
function findCommonSubstrings(strList) {
    // 边界情况处理：如果数组为空
    if (!strList || strList.length === 0) {
        return [];
    }

    // 1. 为了优化性能，找到长度最短的字符串作为基准 (Reference)
    const shortestStr = strList.reduce((a, b) => a.length <= b.length ? a : b);
    const n = shortestStr.length;

    const commonCandidates = new Set();

    // 2. 获取基准字符串的所有子串，并检查是否在其他所有字符串中出现
    // 外层循环遍历所有可能的长度
    for (let length = 1; length <= n; length++) {
        // 内层循环遍历该长度下的所有起始位置
        for (let i = 0; i <= n - length; i++) {
            const sub = shortestStr.substring(i, i + length);

            // 检查这个子串是否存在于数组的所有字符串中
            if (strList.every(s => s.includes(sub))) {
                commonCandidates.add(sub);
            }
        }
    }

    // 如果没有公共子串，直接返回空
    if (commonCandidates.size === 0) {
        return [];
    }

    // 3. 提取“极大”子串
    // 先将候选子串按长度从长到短排序
    const sortedCandidates = Array.from(commonCandidates).sort((a, b) => b.length - a.length);

    const result = [];

    for (const cand of sortedCandidates) {
        // 检查当前 cand 是否是 result 中已存在的某个字符串的子串
        let isSubset = false;
        for (const existing in result) {
            if (result[existing].includes(cand)) {
                isSubset = true;
                break;
            }
        }

        // 如果它不是任何现有结果的子集，则将其加入结果
        if (!isSubset) {
            result.push(cand);
        }
    }

    return result;
}

function highlightFileName(fileName, commonSubstrings) {
    if (!commonSubstrings || commonSubstrings.length === 0) {
        return fileName;
    }

    // 创建一个布尔数组标记哪些字符是公共部分
    const isCommon = new Array(fileName.length).fill(false);

    // 对每个公共子串，在文件名中找到所有出现位置并标记
    const sortedCommons = [...commonSubstrings].sort((a, b) => b.length - a.length);

    for (const sub of sortedCommons) {
        let startPos = 0;
        while (true) {
            const index = fileName.indexOf(sub, startPos);
            if (index === -1) break;

            // 标记该区间的字符为公共
            for (let k = 0; k < sub.length; k++) {
                isCommon[index + k] = true;
            }
            startPos = index + 1; // 继续查找下一个（允许重叠查找，但标记是幂等的）
        }
    }

    // 根据标记构建 HTML
    let html = '';
    let currentType = null; // 'common' or 'unique'
    let buffer = '';

    for (let i = 0; i < fileName.length; i++) {
        const type = isCommon[i] ? 'common' : 'unique';

        if (type !== currentType) {
            if (buffer) {
                if (currentType === 'common') {
                    html += `<span class="common-part">${buffer}</span>`;
                } else {
                    html += `<span class="unique-part">${buffer}</span>`;
                }
            }
            buffer = fileName[i];
            currentType = type;
        } else {
            buffer += fileName[i];
        }
    }

    // 处理最后一个片段
    if (buffer) {
        if (currentType === 'common') {
            html += `<span class="common-part">${buffer}</span>`;
        } else {
            html += `<span class="unique-part">${buffer}</span>`;
        }
    }

    return {
        html: html,
        title: fileName
    };
}

// 修改displayFileGrid函数
function displayFileGrid(files) {
    if (isVideoPlaying) {
        return;
    }
    const contentArea = document.getElementById('contentArea');
    
    if (files.length === 0) {
        contentArea.innerHTML = `
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="text-center">
                    <i class="bi bi-folder-x" style="font-size: 5rem; color: #8B949E;"></i>
                    <p class="text-muted">空目录</p>
                </div>
            </div>
        `;
        return;
    }
    
    // 只显示视频文件
    const videoFiles = files.filter(file => !file.is_dir && isVideoFile(file.name));
    
    if (videoFiles.length === 0) {
        contentArea.innerHTML = `
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="text-center">
                    <i class="bi bi-film" style="font-size: 5rem; color: #8B949E;"></i>
                    <p class="text-muted">此目录中没有视频文件</p>
                </div>
            </div>
        `;
        return;
    }
    
    // 使用全局计算的公共子串
    // const commonSubstrings = currentVideoCommonSubstrings;
    
    let html = '<div class="file-grid">';
    
    videoFiles.forEach(file => {
        // 使用 highlightFileName 函数处理文件名
        const nameResult = highlightFileName(file.name, currentVideoCommonSubstrings);
        const displayHtml = typeof nameResult === 'string' ? nameResult : nameResult.html;
        const displayTitle = typeof nameResult === 'string' ? file.name : nameResult.title;
        
        html += `
            <div class="file-card video-card" onclick="playVideo('${file.name}')">
                <div class="file-icon">
                    <i class="bi ${getFileIcon(file.name)}"></i>
                </div>
                <div class="play-overlay">
                    <i class="bi bi-play-fill"></i>
                </div>
                <div class="file-name" title="${displayTitle}">${displayHtml}</div>
                <div class="file-size">${formatBytes(file.size)}</div>
            </div>
        `;
    });
    
    html += '</div>';
    contentArea.innerHTML = html;
}
</script>