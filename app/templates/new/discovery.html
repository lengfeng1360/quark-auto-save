<style>
    /* Custom scrollbar for webkit browsers */
    .results-grid::-webkit-scrollbar {
        width: 8px;
    }
    .results-grid::-webkit-scrollbar-track {
        background: #161B22;
    }
    .results-grid::-webkit-scrollbar-thumb {
        background-color: #30363D;
        border-radius: 4px;
        border: 2px solid #161B22;
    }

    .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
        max-height: 75vh;
        overflow-y: auto;
        padding: 0 1rem;
    }
    .card {
        background-color: #161B22;
        border: 1px solid #30363D;
        color: #C9D1D9;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .card-body {
        flex-grow: 1;
    }
    .card-title a {
        color: #58A6FF;
        text-decoration: none;
    }
    .card-title a:hover {
        text-decoration: underline;
    }
    .card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .card-text.small {
        display: -webkit-box;
        -webkit-line-clamp: 3; /* Limit to 3 lines */
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        height: 60px; /* Assuming 3 lines with 1.25rem line-height and 0.875em font-size */
    }
    #discoveryHeader {
        transition: all 0.5s ease-in-out;
        overflow: hidden;
        max-height: 200px;
    }
    #discoveryHeader.collapsed {
        max-height: 0;
        opacity: 0;
        margin: 0;
        padding: 0;
    }
</style>
<div class="container-fluid mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8 text-center">
            <div id="discoveryHeader">
                <h1 class="display-4">资源发现</h1>
                <p class="lead">在多个资源提供商中搜索资源。</p>
                <p class="small text-secondary">搜索到资源后，点击 <i class="bi bi-send-plus"></i> 按钮即可发送到下载页面进行转存。</p>
            </div>
            <div class="input-group mb-3">
                <input type="text" id="searchInput" class="form-control" placeholder="搜索电影、剧集、软件...">
                <button class="btn btn-primary" type="button" id="searchButton"><i class="bi bi-search"></i> 搜索</button>
            </div>
        </div>
    </div>

    <div id="loadingSpinner" class="text-center mt-4" style="display: none;">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
    </div>

    <div id="errorMessage" class="alert alert-danger mt-4" style="display: none;" role="alert">
    </div>

    <div id="resultsContainer" class="results-grid mt-4">
        <!-- Search results will be inserted here as cards -->
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const searchButton = document.getElementById('searchButton');
    const searchInput = document.getElementById('searchInput');
    const resultsContainer = document.getElementById('resultsContainer');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const errorMessage = document.getElementById('errorMessage');

    const performSearch = () => {
        const query = searchInput.value.trim();
        if (query === '') {
            errorMessage.textContent = '请输入搜索词。';
            errorMessage.style.display = 'block';
            return;
        }

        loadingSpinner.style.display = 'block';
        resultsContainer.innerHTML = '';
        errorMessage.style.display = 'none';

        axios.get('/task_suggestions', {
            params: {
                q: query,
                d: 1 
            }
        })
        .then(response => {
            loadingSpinner.style.display = 'none';
            if (response.data.success && response.data.data.length > 0) {
                renderResults(response.data.data);
            } else {
                errorMessage.textContent = '未找到结果。';
                errorMessage.style.display = 'block';
            }
        })
        .catch(error => {
            loadingSpinner.style.display = 'none';
            console.error('Error fetching search results:', error);
            errorMessage.textContent = '获取结果时发生错误。';
            errorMessage.style.display = 'block';
        });
    };

    const renderResults = (results) => {
        const discoveryHeader = document.getElementById('discoveryHeader');
        if (discoveryHeader) {
            discoveryHeader.classList.add('collapsed');
        }
        resultsContainer.innerHTML = ''; // Clear previous results
        results.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';

            const title = document.createElement('h5');
            title.className = 'card-title';
            const titleLink = document.createElement('a');
            titleLink.href = item.shareurl;
            titleLink.target = '_blank';
            titleLink.textContent = item.taskname;
            title.appendChild(titleLink);

            const description = document.createElement('p');
            description.className = 'card-text small';
            const fullDescription = item.content || '暂无描述。';
            description.textContent = fullDescription;
            description.setAttribute('data-bs-toggle', 'tooltip');
            description.setAttribute('data-bs-placement', 'bottom');
            description.setAttribute('title', fullDescription);

            const footer = document.createElement('div');
            footer.className = 'card-footer bg-transparent border-top-0';
            
            const badges = document.createElement('div');

            const sourceBadge = document.createElement('span');
            sourceBadge.className = 'badge bg-success me-1';
            sourceBadge.textContent = item.source || '网络';
            
            const channelBadge = document.createElement('span');
            channelBadge.className = 'badge bg-info me-1';
            channelBadge.textContent = item.channel || '未知';
            
            badges.appendChild(sourceBadge);
            badges.appendChild(channelBadge);

            const transferButton = document.createElement('button');
            transferButton.className = 'btn btn-sm btn-outline-light';
            transferButton.innerHTML = '<i class="bi bi-send-plus"></i>';
            transferButton.title = '发送到下载';
            transferButton.onclick = () => {
                localStorage.setItem('shareUrlToTransfer', item.shareurl);
                const navLink = document.querySelector('a.nav-link[data-page="transfer"]');
                if (navLink) {
                    navLink.click();
                    // Scroll to top
                    window.scrollTo(0, 0);
                }
            };
            
            cardBody.appendChild(title);
            cardBody.appendChild(description);
            footer.appendChild(badges);
            footer.appendChild(transferButton);
            card.appendChild(cardBody);
            card.appendChild(footer);

            resultsContainer.appendChild(card);
        });

        // Initialize tooltips after rendering
        const tooltipTriggerList = Array.from(resultsContainer.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(tooltipTriggerEl => {
            new bootstrap.Tooltip(tooltipTriggerEl);
        });
    };

    searchButton.addEventListener('click', performSearch);
    searchInput.addEventListener('keyup', function (event) {
        if (event.key === 'Enter') {
            performSearch();
        }
    });
});
</script>